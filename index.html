<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í—¤ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½ ì„œë¹„ìŠ¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            padding: 40px 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .step-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .step-box {
            background: #f8fafc;
            border-radius: 16px;
            padding: 30px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .step-box:hover {
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.1);
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: #ebf4ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #4a5568;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #718096;
            font-size: 0.9rem;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }

        .canvas-wrapper {
            display: inline-block;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .canvas-controls {
            background: #f8fafc;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-label {
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
        }

        .brush-size-slider {
            width: 100px;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .brush-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .mask-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .mask-complete {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .mask-incomplete {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .process-section {
            text-align: center;
            margin: 40px 0;
        }

        .process-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px auto;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            color: #4a5568;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .result-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            margin-top: 40px;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 30px;
        }

        .result-image {
            max-width: 100%;
            max-height: 600px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .download-btn {
            background: #48bb78;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .reset-btn {
            background: #4a5568;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #2d3748;
        }

        .guide-section {
            background: linear-gradient(135deg, #667eea22, #764ba222);
            border-radius: 16px;
            padding: 30px;
            margin-top: 40px;
            border: 1px solid #e2e8f0;
        }

        .guide-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .guide-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .guide-step {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .guide-step h4 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .guide-step p {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .step-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .canvas-controls {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AI í—¤ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½</h1>
            <p>ë§ˆìŠ¤í‚¹ìœ¼ë¡œ ì •í™•í•œ ì˜ì—­ì„ ì§€ì •í•˜ì—¬ ì›í•˜ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì™„ë²½í•˜ê²Œ ë³µì‚¬í•˜ì„¸ìš”</p>
        </div>

        <div class="main-content">
            <div class="step-container">
                <!-- ì‹œë“œ ì´ë¯¸ì§€ ì„¹ì…˜ -->
                <div class="step-box">
                    <div class="step-title">
                        <div class="step-number">1</div>
                        ì‹œë“œ ì´ë¯¸ì§€ (A) - ê¸°ë³¸ ì‚¬ì§„
                    </div>
                    
                    <div class="upload-area" id="seedUpload">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">ì–¼êµ´/ë°°ê²½/ì˜·ì„ ìœ ì§€í•  ê¸°ë³¸ ì´ë¯¸ì§€</div>
                        <div class="upload-subtext">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <input type="file" id="seedFile" accept="image/*" class="hidden">
                    </div>

                    <div id="seedPreview" class="hidden">
                        <img id="seedImage" class="image-preview" alt="ì‹œë“œ ì´ë¯¸ì§€">
                        <div class="canvas-container">
                            <div class="canvas-wrapper">
                                <canvas id="seedCanvas"></canvas>
                                <div class="canvas-controls">
                                    <div class="control-group">
                                        <span class="control-label">ë¸ŒëŸ¬ì‹œ í¬ê¸°:</span>
                                        <input type="range" id="seedBrushSize" class="brush-size-slider" 
                                               min="5" max="50" value="20">
                                        <span id="seedBrushValue">20px</span>
                                    </div>
                                    <button class="btn btn-secondary" onclick="clearSeedMask()">ì§€ìš°ê¸°</button>
                                    <button class="btn btn-primary" onclick="completeSeedMask()">ë§ˆìŠ¤í¬ ì™„ë£Œ</button>
                                </div>
                            </div>
                        </div>
                        <div id="seedMaskStatus" class="mask-status mask-incomplete">
                            ğŸ”´ ë³€ê²½í•˜ê³  ì‹¶ì€ í—¤ì–´ ë¶€ë¶„ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì¹ í•´ì£¼ì„¸ìš”
                        </div>
                    </div>
                </div>

                <!-- ì°¸ì¡° ì´ë¯¸ì§€ ì„¹ì…˜ -->
                <div class="step-box">
                    <div class="step-title">
                        <div class="step-number">2</div>
                        ì°¸ì¡° ì´ë¯¸ì§€ (B) - í—¤ì–´ìŠ¤íƒ€ì¼
                    </div>
                    
                    <div class="upload-area" id="referenceUpload">
                        <div class="upload-icon">âœ¨</div>
                        <div class="upload-text">ë³µì‚¬í•  í—¤ì–´ìŠ¤íƒ€ì¼ì´ ìˆëŠ” ì´ë¯¸ì§€</div>
                        <div class="upload-subtext">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <input type="file" id="referenceFile" accept="image/*" class="hidden">
                    </div>

                    <div id="referencePreview" class="hidden">
                        <img id="referenceImage" class="image-preview" alt="ì°¸ì¡° ì´ë¯¸ì§€">
                        <div class="canvas-container">
                            <div class="canvas-wrapper">
                                <canvas id="referenceCanvas"></canvas>
                                <div class="canvas-controls">
                                    <div class="control-group">
                                        <span class="control-label">ë¸ŒëŸ¬ì‹œ í¬ê¸°:</span>
                                        <input type="range" id="referenceBrushSize" class="brush-size-slider" 
                                               min="5" max="50" value="20">
                                        <span id="referenceBrushValue">20px</span>
                                    </div>
                                    <button class="btn btn-secondary" onclick="clearReferenceMask()">ì§€ìš°ê¸°</button>
                                    <button class="btn btn-primary" onclick="completeReferenceMask()">ë§ˆìŠ¤í¬ ì™„ë£Œ</button>
                                </div>
                            </div>
                        </div>
                        <div id="referenceMaskStatus" class="mask-status mask-incomplete">
                            ğŸŸ¢ ë³µì‚¬í•  í—¤ì–´ ë¶€ë¶„ì„ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ì¹ í•´ì£¼ì„¸ìš”
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì²˜ë¦¬ ë²„íŠ¼ -->
            <div class="process-section">
                <button class="process-btn" id="processBtn" onclick="processHairTransfer()" disabled>
                    <span id="processText">í—¤ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½í•˜ê¸°</span>
                </button>
                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text hidden" id="progressText">ì¤€ë¹„ ì¤‘...</div>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ -->
            <div class="result-section" id="resultSection">
                <div class="result-title">ğŸ‰ ë³€ê²½ ì™„ë£Œ!</div>
                <img id="resultImage" class="result-image" alt="ê²°ê³¼ ì´ë¯¸ì§€">
                <div class="result-actions">
                    <a id="downloadLink" class="download-btn" download="hair-transfer-result.png">
                        ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                    </a>
                    <button class="reset-btn" onclick="resetAll()">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
                </div>
            </div>

            <!-- ì‚¬ìš©ë²• ì•ˆë‚´ -->
            <div class="guide-section">
                <div class="guide-title">ğŸ“– ì‚¬ìš©ë²•</div>
                <div class="guide-steps">
                    <div class="guide-step">
                        <h4>1ë‹¨ê³„: ì‹œë“œ ì´ë¯¸ì§€</h4>
                        <p>ì–¼êµ´, ë°°ê²½, ì˜·ì„ ìœ ì§€í•  ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë³€ê²½í•˜ê³  ì‹¶ì€ í—¤ì–´ ë¶€ë¶„ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì¹ í•˜ì„¸ìš”.</p>
                    </div>
                    <div class="guide-step">
                        <h4>2ë‹¨ê³„: ì°¸ì¡° ì´ë¯¸ì§€</h4>
                        <p>ì›í•˜ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ì´ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë³µì‚¬í•  í—¤ì–´ ë¶€ë¶„ì„ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ì¹ í•˜ì„¸ìš”.</p>
                    </div>
                    <div class="guide-step">
                        <h4>3ë‹¨ê³„: ì²˜ë¦¬</h4>
                        <p>ë‘ ì´ë¯¸ì§€ ëª¨ë‘ ë§ˆìŠ¤í‚¹ì„ ì™„ë£Œí•˜ë©´ 'í—¤ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½í•˜ê¸°' ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤. (ì•½ 30-60ì´ˆ ì†Œìš”)</p>
                    </div>
                    <div class="guide-step">
                        <h4>4ë‹¨ê³„: ê²°ê³¼</h4>
                        <p>Aì˜ ì–¼êµ´/ë°°ê²½/ì˜· + Bì˜ í—¤ì–´ìŠ¤íƒ€ì¼ì´ í•©ì³ì§„ ìì—°ìŠ¤ëŸ¬ìš´ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤
        let seedCanvas, referenceCanvas;
        let seedMaskComplete = false;
        let referenceMaskComplete = false;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUploads();
            setupBrushControls();
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupFileUploads() {
            // ì‹œë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
            const seedUpload = document.getElementById('seedUpload');
            const seedFile = document.getElementById('seedFile');

            seedUpload.addEventListener('click', () => seedFile.click());
            seedUpload.addEventListener('dragover', handleDragOver);
            seedUpload.addEventListener('dragleave', handleDragLeave);
            seedUpload.addEventListener('drop', (e) => handleSeedDrop(e));
            seedFile.addEventListener('change', (e) => handleSeedUpload(e));

            // ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë¡œë“œ
            const referenceUpload = document.getElementById('referenceUpload');
            const referenceFile = document.getElementById('referenceFile');

            referenceUpload.addEventListener('click', () => referenceFile.click());
            referenceUpload.addEventListener('dragover', handleDragOver);
            referenceUpload.addEventListener('dragleave', handleDragLeave);
            referenceUpload.addEventListener('drop', (e) => handleReferenceDrop(e));
            referenceFile.addEventListener('change', (e) => handleReferenceUpload(e));
        }

        // ë“œë˜ê·¸ ì˜¤ë²„ íš¨ê³¼
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        // ì‹œë“œ ì´ë¯¸ì§€ ì²˜ë¦¬
        function handleSeedDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleSeedFile(files[0]);
            }
        }

        function handleSeedUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleSeedFile(file);
            }
        }

        function handleSeedFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('seedImage').src = e.target.result;
                document.getElementById('seedPreview').classList.remove('hidden');
                setupSeedCanvas(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // ì°¸ì¡° ì´ë¯¸ì§€ ì²˜ë¦¬
        function handleReferenceDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleReferenceFile(files[0]);
            }
        }

        function handleReferenceUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleReferenceFile(file);
            }
        }

        function handleReferenceFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('referenceImage').src = e.target.result;
                document.getElementById('referencePreview').classList.remove('hidden');
                setupReferenceCanvas(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // ìº”ë²„ìŠ¤ ì„¤ì •
        function setupSeedCanvas(imageSrc) {
            const canvasElement = document.getElementById('seedCanvas');
            seedCanvas = new fabric.Canvas(canvasElement, {
                width: 512,
                height: 512,
                isDrawingMode: true
            });

            seedCanvas.freeDrawingBrush.width = 20;
            seedCanvas.freeDrawingBrush.color = '#ff0000'; // ë¹¨ê°„ìƒ‰

            fabric.Image.fromURL(imageSrc, function(img) {
                img.scaleToWidth(512);
                img.scaleToHeight(512);
                img.selectable = false;
                seedCanvas.setBackgroundImage(img, seedCanvas.renderAll.bind(seedCanvas));
            });
        }

        function setupReferenceCanvas(imageSrc) {
            const canvasElement = document.getElementById('referenceCanvas');
            referenceCanvas = new fabric.Canvas(canvasElement, {
                width: 512,
                height: 512,
                isDrawingMode: true
            });

            referenceCanvas.freeDrawingBrush.width = 20;
            referenceCanvas.freeDrawingBrush.color = '#00ff00'; // ì´ˆë¡ìƒ‰

            fabric.Image.fromURL(imageSrc, function(img) {
                img.scaleToWidth(512);
                img.scaleToHeight(512);
                img.selectable = false;
                referenceCanvas.setBackgroundImage(img, referenceCanvas.renderAll.bind(referenceCanvas));
            });
        }

        // ë¸ŒëŸ¬ì‹œ ì»¨íŠ¸ë¡¤ ì„¤ì •
        function setupBrushControls() {
            const seedBrushSize = document.getElementById('seedBrushSize');
            const seedBrushValue = document.getElementById('seedBrushValue');
            const referenceBrushSize = document.getElementById('referenceBrushSize');
            const referenceBrushValue = document.getElementById('referenceBrushValue');

            seedBrushSize.addEventListener('input', function() {
                const size = this.value;
                seedBrushValue.textContent = size + 'px';
                if (seedCanvas) {
                    seedCanvas.freeDrawingBrush.width = parseInt(size);
                }
            });

            referenceBrushSize.addEventListener('input', function() {
                const size = this.value;
                referenceBrushValue.textContent = size + 'px';
                if (referenceCanvas) {
                    referenceCanvas.freeDrawingBrush.width = parseInt(size);
                }
            });
        }

        // ë§ˆìŠ¤í¬ ì§€ìš°ê¸°
        function clearSeedMask() {
            if (seedCanvas) {
                seedCanvas.getObjects().forEach(obj => {
                    if (obj.type === 'path') {
                        seedCanvas.remove(obj);
                    }
                });
                seedCanvas.renderAll();
                seedMaskComplete = false;
                updateSeedMaskStatus();
                updateProcessButton();
            }
        }

        function clearReferenceMask() {
            if (referenceCanvas) {
                referenceCanvas.getObjects().forEach(obj => {
                    if (obj.type === 'path') {
                        referenceCanvas.remove(obj);
                    }
                });
                referenceCanvas.renderAll();
                referenceMaskComplete = false;
                updateReferenceMaskStatus();
                updateProcessButton();
            }
        }

        // ë§ˆìŠ¤í¬ ì™„ë£Œ
        function completeSeedMask() {
            if (seedCanvas && seedCanvas.getObjects().length > 0) {
                seedMaskComplete = true;
                updateSeedMaskStatus();
                updateProcessButton();
            } else {
                alert('ë¨¼ì € í—¤ì–´ ì˜ì—­ì„ ì¹ í•´ì£¼ì„¸ìš”!');
            }
        }

        function completeReferenceMask() {
            if (referenceCanvas && referenceCanvas.getObjects().length > 0) {
                referenceMaskComplete = true;
                updateReferenceMaskStatus();
                updateProcessButton();
            } else {
                alert('ë¨¼ì € í—¤ì–´ ì˜ì—­ì„ ì¹ í•´ì£¼ì„¸ìš”!');
            }
        }

        // ë§ˆìŠ¤í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSeedMaskStatus() {
            const status = document.getElementById('seedMaskStatus');
            if (seedMaskComplete) {
                status.className = 'mask-status mask-complete';
                status.textContent = 'âœ… ì‹œë“œ ì´ë¯¸ì§€ ë§ˆìŠ¤í‚¹ ì™„ë£Œ!';
            } else {
                status.className = 'mask-status mask-incomplete';
                status.textContent = 'ğŸ”´ ë³€ê²½í•˜ê³  ì‹¶ì€ í—¤ì–´ ë¶€ë¶„ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì¹ í•´ì£¼ì„¸ìš”';
            }
        }

        function updateReferenceMaskStatus() {
            const status = document.getElementById('referenceMaskStatus');
            if (referenceMaskComplete) {
                status.className = 'mask-status mask-complete';
                status.textContent = 'âœ… ì°¸ì¡° ì´ë¯¸ì§€ ë§ˆìŠ¤í‚¹ ì™„ë£Œ!';
            } else {
                status.className = 'mask-status mask-incomplete';
                status.textContent = 'ğŸŸ¢ ë³µì‚¬í•  í—¤ì–´ ë¶€ë¶„ì„ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ì¹ í•´ì£¼ì„¸ìš”';
            }
        }

        // ì²˜ë¦¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            if (seedMaskComplete && referenceMaskComplete) {
                processBtn.disabled = false;
                processBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
            } else {
                processBtn.disabled = true;
                processBtn.style.background = '#a0aec0';
            }
        }

        // API ê¸°ë³¸ URL ì„¤ì • (í™˜ê²½ì— ë”°ë¼ ìë™ ê°ì§€)
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://your-backend-api.railway.app';  // ì‹¤ì œ ë°±ì—”ë“œ URLë¡œ ë³€ê²½

        // í—¤ì–´ ì „ì†¡ ì²˜ë¦¬
        async function processHairTransfer() {
            if (!seedMaskComplete || !referenceMaskComplete) {
                alert('ë‘ ì´ë¯¸ì§€ ëª¨ë‘ ë§ˆìŠ¤í‚¹ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!');
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            const processBtn = document.getElementById('processBtn');
            const processText = document.getElementById('processText');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            processBtn.disabled = true;
            processText.innerHTML = '<span class="loading-spinner"></span>ì²˜ë¦¬ ì¤‘...';
            progressBar.classList.remove('hidden');
            progressText.classList.remove('hidden');

            try {
                // 1. ì´ë¯¸ì§€ì™€ ë§ˆìŠ¤í¬ ë°ì´í„° ì¶”ì¶œ
                progressText.textContent = 'ì´ë¯¸ì§€ ë°ì´í„° ì¤€ë¹„ ì¤‘...';
                progressFill.style.width = '10%';

                const seedImageData = document.getElementById('seedImage').src;
                const referenceImageData = document.getElementById('referenceImage').src;
                const seedMaskData = extractMaskFromCanvas(seedCanvas);
                const referenceMaskData = extractMaskFromCanvas(referenceCanvas);

                // 2. ì„œë²„ì— ìš”ì²­ ì „ì†¡
                progressText.textContent = 'ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...';
                progressFill.style.width = '25%';

                const formData = new FormData();
                formData.append('seed_image', dataURItoBlob(seedImageData));
                formData.append('seed_mask', dataURItoBlob(seedMaskData));
                formData.append('reference_image', dataURItoBlob(referenceImageData));
                formData.append('reference_mask', dataURItoBlob(referenceMaskData));

                const response = await fetch(`${API_BASE_URL}/api/transfer-hair`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ì„œë²„ ìš”ì²­ ì‹¤íŒ¨');
                }

                const result = await response.json();
                const jobId = result.job_id;

                // 3. ì‘ì—… ìƒíƒœ í´ë§
                progressText.textContent = 'AIê°€ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬ ì¤‘...';
                progressFill.style.width = '50%';

                await pollJobStatus(jobId, progressFill, progressText);

            } catch (error) {
                console.error('Error:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // UI ë¦¬ì…‹
                processBtn.disabled = false;
                processText.textContent = 'í—¤ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½í•˜ê¸°';
                progressBar.classList.add('hidden');
                progressText.classList.add('hidden');
            }
        }

        // ìº”ë²„ìŠ¤ì—ì„œ ë§ˆìŠ¤í¬ ì¶”ì¶œ
        function extractMaskFromCanvas(canvas) {
            // ë°°ê²½ ì œê±°í•˜ê³  ë§ˆìŠ¤í¬ë§Œ ì¶”ì¶œ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 512;
            tempCanvas.height = 512;
            const tempFabricCanvas = new fabric.Canvas(tempCanvas);

            // íŒ¨ìŠ¤ ê°ì²´ë§Œ ë³µì‚¬
            const paths = canvas.getObjects().filter(obj => obj.type === 'path');
            paths.forEach(path => {
                tempFabricCanvas.add(path.clone());
            });

            const maskDataURL = tempFabricCanvas.toDataURL('image/png');
            tempFabricCanvas.dispose();
            
            return maskDataURL;
        }

        // ì‘ì—… ìƒíƒœ í´ë§
        async function pollJobStatus(jobId, progressFill, progressText) {
            const maxAttempts = 60; // 2ë¶„ ìµœëŒ€ ëŒ€ê¸°
            let attempts = 0;

            return new Promise((resolve, reject) => {
                const pollInterval = setInterval(async () => {
                    attempts++;
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/job-status/${jobId}`);
                        const data = await response.json();

                        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                        const progress = Math.min(50 + (attempts * 2), 95);
                        progressFill.style.width = progress + '%';

                        if (data.status === 'COMPLETED') {
                            progressFill.style.width = '100%';
                            progressText.textContent = 'ì™„ë£Œ!';
                            
                            // ê²°ê³¼ í‘œì‹œ
                            showResult(data.result_url);
                            clearInterval(pollInterval);
                            resolve();
                            
                        } else if (data.status === 'FAILED') {
                            clearInterval(pollInterval);
                            reject(new Error(data.error || 'ì²˜ë¦¬ ì‹¤íŒ¨'));
                            
                        } else {
                            progressText.textContent = data.progress || 'AI ëª¨ë¸ì´ ì²˜ë¦¬ ì¤‘...';
                        }

                        // íƒ€ì„ì•„ì›ƒ ì²´í¬
                        if (attempts >= maxAttempts) {
                            clearInterval(pollInterval);
                            reject(new Error('ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼'));
                        }
                        
                    } catch (error) {
                        clearInterval(pollInterval);
                        reject(error);
                    }
                }, 2000);
            });
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(resultUrl) {
            const resultSection = document.getElementById('resultSection');
            const resultImage = document.getElementById('resultImage');
            const downloadLink = document.getElementById('downloadLink');

            resultImage.src = resultUrl;
            downloadLink.href = resultUrl;
            resultSection.classList.add('show');

            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ë°ì´í„° URIë¥¼ Blobìœ¼ë¡œ ë³€í™˜
        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            return new Blob([ab], { type: mimeString });
        }

        // ì „ì²´ ë¦¬ì…‹
        function resetAll() {
            // ì´ë¯¸ì§€ ì´ˆê¸°í™”
            document.getElementById('seedPreview').classList.add('hidden');
            document.getElementById('referencePreview').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('show');
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('seedFile').value = '';
            document.getElementById('referenceFile').value = '';
            
            // ìº”ë²„ìŠ¤ ì •ë¦¬
            if (seedCanvas) {
                seedCanvas.dispose();
                seedCanvas = null;
            }
            if (referenceCanvas) {
                referenceCanvas.dispose();
                referenceCanvas = null;
            }
            
            // ìƒíƒœ ì´ˆê¸°í™”
            seedMaskComplete = false;
            referenceMaskComplete = false;
            updateProcessButton();
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (seedCanvas) seedCanvas.dispose();
            if (referenceCanvas) referenceCanvas.dispose();
        });
    </script>
</body>
</html>
